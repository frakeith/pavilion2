base:
    summary: Intel MPI Test.

    maintainer:
        name: Francine Lapid
        email: lapid@lanl.gov

    doc: |

      This tests the ability to complete MPI communications between all of the
      nodes.  Failures will mostly indicate nodes that aren't able to communicate
      across the HSN fabric.  MPI errors should indicate where to look for the
      source of the issue.
      If other failures are encountered, be sure to take notes of the form of the
      failure and the fix to be merged into this file.

    slurm:
        tasks_per_node: 2

    variables:
      mpi_cc: mpicc

    build:
        source_download: https://github.com/intel/mpi-benchmarks/archive/refs/heads/master.zip
        source_path: imb.zip

        modules:
            - "{{var.compilers}}"
            - "{{var.mpis}}"

        cmds:
            - cd src_c
            - "make CC={{mp_cc}}"
    run:
        modules:
            - "{{var.compilers}}"
            - "{{var.mpis}}"

        cmds:
            - cd src_c
            - "{{sched.test_cmd}} ./IMB-MPI1 -npmin {{sched.alloc_cpu_total}} -mem 50 alltoall"
